<html>
    <head>
        <title>Cloud Stuff</title>
        <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
        <style>
            body {
                color: cadetblue;
                }
        </style>
    </head>
    <body>

        <h1 id="fbTrace"></h1>
        <p id="lastChatMsg"></p>
        <div id="imageViewer"></div>

        <script type="text/javascript">

            let scoreskeeper = [];

            class score
            {
                constructor(user, lastMessage, score) {
                    this.user = user;
                    this.lastMessage = lastMessage;
                    this.highestScore = score;
                }
            }

            searchByUser = function(userName)
            {
                    for (var i=0; i < scoreskeeper.length; i++) {
                        if (scoreskeeper[i].user === userName) {
                            console.log( "... found in position: " + i );
                            return i;
                        }
                    }
                    return -1;
            }


            testAzFunc = async function(name, callback)
            {
                const Http = new XMLHttpRequest();
                const url=`http://<FunctionAppName>.azurewebsites.net/api/WhatsNew?name=${name}`;
                Http.open("GET", url);
                Http.send();
                Http.onreadystatechange = (e) => {
                    callback(Http.responseText);
                } 
            }

            updateTrace = function(message)
            {
                document.querySelector("#fbTrace").innerHTML = message;
            }


            clean = function()
            {
                document.querySelector("#imageViewer").innerHTML = "";
                document.querySelector("#lastChatMsg").innerHTML = "";
                document.querySelector("#fbTrace").innerHTML = "";
            }

            test = function(message)
            {
                console.log( "!test was typed in chat" );
                document.querySelector("#fbTrace").innerText = message 
            }

            cloud = function()
            {
                console.log( "!cloud was typed in chat" );
                document.querySelector("#imageViewer").innerHTML = "<img src='medias/smillingcloud.gif' class='nuage'>";
            }

            scores = function()
            {
                console.log( "!scores was typed in chat" );

                let strMsg = "<table>";
                for (var i=0; i < scoreskeeper.length; i++) {
                    strMsg += "<tr>";
                    strMsg += `<td>${scoreskeeper[i].user}</td><td>${scoreskeeper[i].highestScore}</td>`;
                    strMsg += "</tr>";
                }
                strMsg += "</table>";

                document.querySelector("#fbTrace").innerHTML = strMsg;
            }

            CheckForHighScore = function(user, curScore)
            {
                let userPos = searchByUser(user);
                console.log( "... userPos: " + userPos);

                if(userPos >= 0)
                {
                    if(scoreskeeper[userPos].highestScore < curScore)
                    {
                        console.log( "... New highscore" + curScore);
                        scoreskeeper[userPos].highestScore = curScore;
                        HightScoreParty(user, curScore);
                    }
                }
                else
                {
                    scoreskeeper.push(new score(user, "", curScore));
                }
            }

            AddUserToScoreKeeper = function()
            {
                scoreskeeper.push(new score(user, message, 0));
            }
                 
            
            ParseMessage = function(message)
            {
                // FBoucheros: theunoriginaljerk landed for 86.60!
                let splitedMsg = message.split(" ");
                let user = splitedMsg[0];
                let curScore = splitedMsg[3].slice(0, -1);

                if(splitedMsg.length > 1 && splitedMsg[1] === "landed")
                {
                    CheckForHighScore(user, curScore);
                }
            }

            HightScoreParty = function(user, score){
                test(`${user} just beat his/her highest score! now at: ${score}`);
                cloud();
            }
            

            ComfyJS.onCommand = async ( user, command, message, flags, extra ) => {
                if( command === "test" ) {
                    test(message);
                }
                else if( flags.broadcaster && command === "cloud" ) {
                    cloud();
                }
                else if( flags.broadcaster && command === "clean" ) {
                    console.log( "!clean was typed in chat" );
                    clean();
                }
                else if( command === "az" ) {
                    console.log( "!az was typed in chat" );
                    testAzFunc(message, updateTrace);
                }
                else if( flags.broadcaster && command === "scores" ) 
                {
                    scores();
                }
            }

            ComfyJS.onChat = ( user, message, flags, self, extra ) => {
               
                console.log(
                    `new incoming...`
                );   

                if( flags.broadcaster) {
                    console.log( "!clean was typed in chat" );
                    clean();
                }

                if( flags.broadcaster) {
                    console.log( "Frank message" );
                    ParseMessage(message);
                }
                
                document.querySelector("#lastChatMsg").innerText = message; 
            }

            ComfyJS.Init( "fboucheros" );
          </script>
    </body>
</html>
